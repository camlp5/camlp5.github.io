

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Camlp5 sources &mdash; Camlp5  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'./',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="About" href="about.html" />
    <link rel="prev" title="Library" href="library.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Camlp5
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="strict.html">Transitional and Strict modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="ptools.html">Parsing and Printing tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="parsing-tools.html">Printing tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="printing-tools.html">Parsing tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="language-extensions.html">Language extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="conclusion.html">Future work</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="appendix.html">Appendix</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="commands.html">Commands and Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="library.html">Library</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Camlp5 sources</a></li>
<li class="toctree-l2"><a class="reference internal" href="about.html">About</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Camlp5</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="appendix.html">Appendix</a> &raquo;</li>
        
      <li>Camlp5 sources</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/camlp5/camlp5/blob/master/doc/rstsources.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="camlp5-sources">
<h1>Camlp5 sources<a class="headerlink" href="#camlp5-sources" title="Permalink to this headline">¶</a></h1>
<div class="docutils container" id="content">
<p class="top rubric" id="id1">Camlp5 sources</p>
<p>Information for developpers of the Camlp5 program.</p>
<p class="rubric" id="kernel">Kernel</p>
<p>The sources are composed of:</p>
<ul class="simple">
<li>the OCaml stuff, copied from the OCaml compiler</li>
<li>the <em>kernel</em> composed of the directories:<ul>
<li>odyl : the dynamic loading system</li>
<li>lib : the library</li>
<li>main : the main program camlp5</li>
<li>meta : the parsers for revised syntax, ast quotations, EXTEND
statement, etc/</li>
</ul>
</li>
<li>the rest: directories etc, compile, ocpp</li>
</ul>
<p>Some other directories contain configuration files, tools,
documentation and manual pages.</p>
<p>The kernel is sufficient to make the core system work: it is possible
to compile and bootstrap only it. All sources being in revised
syntax, the first compilation of Camlp5 is done by a version of this
kernel in pure OCaml syntax, located in the directory ocaml_src.</p>
<p>These sources in pure OCaml syntax are not modified by hand. When
changes are made to the kernel, and a check is done that it correctly
compiles and bootstraps, the kernel in pure OCaml syntax is rebuilt
using Camlp5 pretty print. This is done by the command “make
bootstrap_sources”.</p>
<p class="rubric" id="compatibility">Compatibility</p>
<p>This distribution of Camlp5 is compatible with several versions of
OCaml. The definition of OCaml syntax trees may change from OCaml
version to version, which can be a problem. Since OCaml does not
install the sources nor the compiled versions of its syntax tree, a
copy of the necessary source files, borrowed from the source of the
OCaml compiler is in the directory ‘ocaml_stuff’, in subdirectories
with the OCaml version number.</p>
<p>If the present distribution of Camlp5 is not compatible with the
version of OCaml you have (the command ‘configure’ tells you), it is
possible to add it. For that, you need the sources to your specific
OCaml distribution. If you have them then a ‘configure’ telling you
that camlp5 is not compatible, do:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">steal</span> <span class="n">OCAML_SRC</span><span class="o">=&lt;</span><span class="n">path</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">OCaml</span><span class="o">-</span><span class="n">sources</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This creates a new directory in ‘ocaml_stuff’ with sources of the
syntax tree of your OCaml compiler.</p>
<p>If you want to check that the sources of the syntax tree of OCaml are
up-to-date (e.g. if this is the current OCaml developpement), do:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">compare_stolen</span> <span class="n">OCAML_SRC</span><span class="o">=&lt;</span><span class="n">path</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">OCaml</span><span class="o">-</span><span class="n">sources</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The compatibility is also done with the file ‘lib/versdep.ml’, which
is a module containing miscellaneous features depending to the
version of OCaml.</p>
<p>In the directory ‘ocaml_src’ which contains the pure OCaml sources of
the Camlp5 core (see chapter TREE STRUCTURE below), there are as many
versions of this files as versions of OCaml. They are named
‘version.ml’ in the directory ‘lib/versdep’. If you are adding a new
version of OCaml, you need this file. As a first step, make a copy
from a close version:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">ocaml_src</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">versdep</span>
<span class="n">cp</span> <span class="o">&lt;</span><span class="n">close_version</span><span class="o">&gt;.</span><span class="n">ml</span> <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;.</span><span class="n">ml</span>
</pre></div>
</div>
<p>Then, you can rerun “configure” and do “make core”. If the file
‘ocaml_src/lib/versdep.ml’ has compilation problems, fix them ‘make
core’ again. When it compiles, copy it into the subdirectory
‘versdep’ as ‘&lt;version&gt;.ml’, overwriting the version you copied from
the close version.</p>
<p>Later, the same file ‘lib/versdep.ml’ in Camlp5 syntax may have
similar compilation problems. There is only a single version of this
file, thanks to IFDEF constructs used here or there.</p>
<p>While compiling with some specific version of OCaml, this file is
compiled with ‘OCAML_vers’ defined where ‘vers’ is the version number
form the beginning to the first space or charcter ‘+’ with all dots
converted into underscores. For example, if your OCaml version is
7.04.2+dev35, you can see in the compilation process of versdep.ml
that OCAML_7_04_2 is defined, and you can add statements defined by
the syntax extension ‘pa_macro.cmo’, for example IFDEF OCAML_7_04_2.
Add statements like that in ‘lib/versdep.ml’ to make it compile
successfully.</p>
<p class="rubric" id="tree-structure">Tree structure</p>
<p>The directory ‘ocaml_src’ contains images in pure OCaml syntax of the
directories odyl lib main and meta. This allows the creation of a
core version of Camlp5 with only the OCaml compiler installed.</p>
<p>You can decompose the building of the Camlp5 core into:</p>
<ol class="arabic simple">
<li>make library_cold
just makes the directory ‘ocaml_src/lib’ and copy the cmo and cmi
files into the directory ‘boot’</li>
<li>make compile_cold
makes the other directories of ocaml_src</li>
<li>make promote_cold
copies the executables “camlp5”, “camlp5r” and the syntax
extensions (cmo files) into the directory ‘boot’</li>
</ol>
<p>From this point, the core Camlp5 is in directory ‘boot’. The real
sources in the top directories odyl, lib, main and meta, which are
written in revised syntax with some syntax extensions (grammars,
quotations) can be compiled. To achieve their compilation, you can
do:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">core</span>
</pre></div>
</div>
<p>Or to compile everything do:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="nb">all</span>
</pre></div>
</div>
<p>or just:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span>
</pre></div>
</div>
<p>Notice that doing “make core” or “make all” from scratch (after a
make clean), automatically starts by making the core files from their
pure OCaml versions.</p>
<p class="rubric" id="fast-compilation-from-scratch">Fast compilation from scratch</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">configure</span>
<span class="n">make</span> <span class="n">clean</span> <span class="n">core</span> <span class="n">compare</span>
<span class="n">make</span> <span class="n">coreboot</span>
<span class="n">make</span> <span class="nb">all</span> <span class="n">opt</span> <span class="n">opt</span><span class="o">.</span><span class="n">opt</span>
</pre></div>
</div>
<p class="rubric" id="testing-changes">Testing changes</p>
<ol class="arabic simple">
<li>do your changes</li>
<li>do:</li>
</ol>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">core</span> <span class="n">compare</span>
</pre></div>
</div>
<p>if it says that the bootstrap is ok, you can do:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="nb">all</span>
<span class="n">make</span> <span class="n">opt</span>
<span class="n">make</span> <span class="n">opt</span><span class="o">.</span><span class="n">opt</span>
</pre></div>
</div>
<p>otherwise, to make sure everything is ok, first do:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">coreboot</span>
</pre></div>
</div>
<p>sometimes two bootstraps (‘make coreboot’ twice) are necessary, in
particular if you change things in the directory ‘lib’. It is even
possible that three bootstraps are necessary.</p>
<p>If things go wrong, it is possible to return to the previous version
by typing:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">restore</span> <span class="n">clean_hot</span>
</pre></div>
</div>
<p>then you can change what is necessary and continue by typing:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">core</span>
</pre></div>
</div>
<p>and test the bootstrap again:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">coreboot</span>
</pre></div>
</div>
<p>After several bootstraps (by ‘make coreboot’ or ‘make bootstrap’),
many versions are pushed in the directory ‘boot’ (you can type ‘find
boot -type d -print’ to see that). If your system correctly
bootstraps, you can clean that by typing:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">cleanboot</span>
</pre></div>
</div>
<p>which keeps only two versions. (The command ‘make clean’ also removes
these stack of versions.)</p>
<p class="rubric" id="before-committing-your-changes">Before committing your changes</p>
<p>Make sure that the cold start with pure OCaml sources work. For that,
do:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">compare_sources</span> <span class="o">|</span> <span class="n">less</span>
</pre></div>
</div>
<p>This shows you the changes that would be done in the OCaml pure
sources of the directory ocaml_src.</p>
<p>To make the new versions, do:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">new_sources</span>
<span class="n">make</span> <span class="n">promote_sources</span>
</pre></div>
</div>
<p>Notice that these pure OCaml sources are not supposed to be modified
by hand, but only created by the above commands. Although their
source is pretty printed they are usually not easy to read,
particularly for expanded grammars (of the statement ‘EXTEND’).</p>
<p>If these sources do not compile, due to changes in the OCaml
compiler, it is possible however to edit them. In this case, similar
changes may need to be performed in the normal sources in revised
syntax.</p>
<p>After doing ‘make new_sources’ above, and before doing ‘make
promote_sources’ below, it is possible to do ‘make untouch_sources’
which changes the dates of the newly created files with the dates of
the old files if they are not modified. This way, the “svn commit”
will not need to compare these files, which may be important if your
network is not fast.</p>
<p>The ‘make new_sources’ builds a directory named ‘ocaml_src.new’. If
this directory still exists, due to a previous ‘make new_sources’,
the command fails. In this case, just delete it (rm -rf
ocaml_src.new) without problem: this directory is not part of the
distribution, it is just temporary.</p>
<p>The ‘make clean_sources’ deletes old versions of ocaml_src, keeping
only the last and the before last ones.</p>
<p>The command:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">bootstrap_sources</span>
</pre></div>
</div>
<p>is a shortcut for:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">new_sources</span>
<span class="n">make</span> <span class="n">untouch_sources</span>
<span class="n">make</span> <span class="n">promote_sources</span>
<span class="n">make</span> <span class="n">clean_sources</span>
</pre></div>
</div>
<p>If there are changes in the specific file ‘lib/versdep.ml’, do also:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">compare_all_versdep</span>
</pre></div>
</div>
<p>and possibly:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">bootstrap_all_versdep</span>
</pre></div>
</div>
<p>because this file, in ‘ocaml_src/lib/versdep’ directory has different
versions according to the OCaml version.</p>
<p>After having rebuilt the pure OCaml sources, check that they work by
rebuilding everything from scratch, starting with “configure”.</p>
<p class="rubric" id="if-you-change-the-main-parser">If you change the main parser</p>
<p>If you change the main parser ‘meta/pa_r.ml’, you should check that
the quotations expanders of syntax tree ‘meta/q_MLast.ml’ match the
new version. For that, do:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">meta</span>
<span class="n">make</span> <span class="n">compare_q_MLast</span>
</pre></div>
</div>
<p>If no differences are displayed, it means that ‘q_MLast.ml’ is ok,
relatively to ‘pa_r.ml’.</p>
<p>Otherwise, if the displayed differences seem reasonable, update the
version by typing:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">bootstrap_q_MLast</span>
</pre></div>
</div>
<p>Then returning to the top directory, do ‘make core compare’ and
possibly ‘make coreboot’ (one of several times) to check the
correctness of the file.</p>
<p>And don’t forget, if you want to commit, to re-create the pure OCaml
sources like indicated above.</p>
<p class="rubric" id="adding-new-nodes-to-the-syntax-tree">Adding new nodes to the syntax tree</p>
<p>If new nodes are necessary in the syntax tree, for example because
the OCaml language added itself new nodes, the steps are the
following (with the example of adding the “lazy” pattern node).</p>
<ul>
<li><p class="first">Add the node in the file ‘main/mLast.mli’. Please respect the
design of the nodes by looking at the other nodes. Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">PaLaz</span> <span class="n">of</span> <span class="n">loc</span> <span class="ow">and</span> <span class="n">patt</span>
</pre></div>
</div>
</li>
<li><p class="first">Try to compile (do ‘make’ in the main directory). You are going to
have some errors in files telling you that nodes are missing in
some pattern matchings. Add them, according to the new nodes of
OCaml or looking at other nodes.</p>
</li>
<li><p class="first">Once the compilation is done, try a ‘make bootstrap’ to be sure
everything is OK.</p>
</li>
<li><p class="first">When it is, add the possible concrete syntax in the revised
syntax, i.e. in ‘meta/pa_r.ml’. Since the quotation is not yet
implemented, put it in syntax without quotation. Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s2">&quot;lazy&quot;</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">SELF</span> <span class="o">-&gt;</span> <span class="n">MLast</span><span class="o">.</span><span class="n">PaLaz</span> <span class="n">loc</span> <span class="n">p</span>
</pre></div>
</div>
</li>
<li><p class="first">Do ‘make bootstrap’ again.</p>
</li>
<li><p class="first">Go to the directory ‘meta’ and type:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">compare_q_MLast</span>
</pre></div>
</div>
<p>This command try to compare what should be the AST quotation if it
perfectly matched the syntax. If this comparison seems reasonable,
change the file ‘q_MLast.ml’ by typing:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">bootstrap_q_MLast</span>
</pre></div>
</div>
</li>
<li><p class="first">Do a ‘make bootstrap’ again to check everything is OK. If it is
change the line of ‘meta/pa_r.ml’. In the example, from:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s2">&quot;lazy&quot;</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">SELF</span> <span class="o">-&gt;</span> <span class="n">MLast</span><span class="o">.</span><span class="n">PaLaz</span> <span class="n">loc</span> <span class="n">p</span>
</pre></div>
</div>
<p>to:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>&quot;lazy&quot;; p = SELF -&gt; &lt;:patt&lt; lazy $p$ &gt;&gt;
</pre></div>
</div>
</li>
<li><p class="first">The new syntax should work now in revised syntax. You can complete
the compilation, do a ‘make install’ and check with the toplevel
that it works. Complete with the rest like said above.</p>
</li>
<li><p class="first">You can then complete the other syntaxes (the ‘normal’ syntax, for
example in ‘etc/pa_o.ml’) and the pretty printers.</p>
</li>
</ul>
<p class="rubric" id="switching-between-transitional-and-strict-mode">Switching between transitional and strict mode</p>
<p>If Camlp5 is compiled in some mode, it is possible to change its mode
in two boostrapping steps. Type:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">MODE</span><span class="o">=</span><span class="n">T</span> <span class="n">coreboot</span>
</pre></div>
</div>
<p>to switch to transitional mode, or:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">MODE</span><span class="o">=</span><span class="n">S</span> <span class="n">coreboot</span>
</pre></div>
</div>
<p>to switch to strict mode.</p>
<p>After two (necessary) bootstraps, the kernel is compiled in the new
mode. Complete the compilation by:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">MODE</span><span class="o">=</span><span class="n">T</span> <span class="nb">all</span> <span class="n">opt</span> <span class="n">opt</span><span class="o">.</span><span class="n">opt</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">MODE</span><span class="o">=</span><span class="n">S</span> <span class="nb">all</span> <span class="n">opt</span> <span class="n">opt</span><span class="o">.</span><span class="n">opt</span>
</pre></div>
</div>
<p>according to the new mode you want to use.</p>
<p>Another solution is, of course, recompile everything from scratch:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">clean</span>
<span class="o">./</span><span class="n">configure</span> <span class="o">-</span><span class="n">transitional</span>
<span class="n">make</span> <span class="n">world</span><span class="o">.</span><span class="n">opt</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">clean</span>
<span class="o">./</span><span class="n">configure</span> <span class="o">-</span><span class="n">strict</span>
<span class="n">make</span> <span class="n">world</span><span class="o">.</span><span class="n">opt</span>
</pre></div>
</div>
<p class="rubric" id="bootstrapping">Bootstrapping</p>
<p>Camlp5 is bootstrapped in numerous ways.</p>
<p class="rubric" id="camlp5-executable-bootstrapping">Camlp5 executable bootstrapping</p>
<p>The file ‘main/camlp5r’ is rebuilt each time a bootstrapping command
is used (like ‘make coreboot’ or ‘make bootstrap’). This
bootstrapping command starts with copying it in the directory ‘boot’.
The file ‘boot/camlp5r’ is used to recompile the sources, creating
another file ‘main/camlp5r’. When both files are the same (byte by
byte), the Camlp5 executable is bootstrapped.</p>
<p>Sometimes, in particular when changes are done in the library
(directory ‘lib’), it is necessary to bootstrap twice before having
the message ‘Fixpoint reached, bootstrap succeeded’.</p>
<p>The command ‘make compare’ tells you whether the Camlp5 executable is
currently bootstrapped or not.</p>
<p class="rubric" id="source-bootstrapping">Source bootstrapping</p>
<p>The compilation of Camlp5 starts with the compilation of files of the
directory ocaml_src written in pure OCaml. This creates the files
‘camlp5’ and ‘camlp5r’ in the directory boot. This is called the
‘cold start’.</p>
<p>Once done, the sources of Camlp5 can be compiled using revised syntax
and several syntax extensions, like the statement ‘EXTEND’, for
example, and the quotations of syntax trees.</p>
<p>The core files of Camlp5 are in the directories lib, main, meta,
odyl. There are the same directories in the directory ocaml_src where
all files are equivalent.</p>
<p>When changes are done in the core files, and when the printer kit in
normal syntax ‘etc/pr_o.cmo’ has been created, the files of the
directory ocaml_src can be rebuilt using the command ‘make
bootstrap_sources’. This updates the files in ocaml_src to exactly
reflect the ones in the core, but in pure OCaml syntax.</p>
<p>Bootstrap: the1 files in ocaml_src creates the first Camlp5
executable. The Camlp5 executable can rebuild the files in ocaml_src.</p>
<p class="rubric" id="source-file-q-mlast-ml-bootstrapping">Source file q_MLast.ml bootstrapping</p>
<p>The source file meta/q_MLast.ml (quotation of syntax trees) can be
recreated using the file meta/pa_r.ml (revised syntax). When changes
are done in the file meta/pa_r.ml, a good usage is to go to the
directory ‘meta’ and type:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">compare_q_MLast</span>
</pre></div>
</div>
<p>This shows the possible changes that will be applied to
meta/q_MLast.ml. If they seem to be reasonable, do:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">bootstrap_q_MLast</span>
</pre></div>
</div>
<p>This changes the source file meta/q_MLast.ml. After this command, a
new ‘make compare_q_MLast’ indicates no differences.</p>
<p>After that, a new ‘make bootstrap’ in the top directory ensures that
everythings works.</p>
<p>Bootstrap: the file meta/pa_r.ml uses the quotation expander
meta/q_MLast.cmo. The source file meta/q_MLast.ml is recreated by
meta/pa_r.ml.</p>
<p class="rubric" id="source-file-q-ast-ml-bootstrapping">Source file q_ast.ml bootstrapping</p>
<p>The source file meta/q_ast.ml contains another version of the
quotation expander of syntax trees which follows the current syntax
used (in normal syntax if the current syntax is used). This works
only in strict mode.</p>
<p>This file depends on the definition of the syntax tree
main/mLast.mli. When changes are done in this file, it is possible to
see what changes are impacted in meta/q_ast.ml. For this, go to the
directory ‘meta’ and type:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">compare_q_ast</span>
</pre></div>
</div>
<p>This shows the possible changes that will be applied to
meta/q_ast.ml. If they seem to be reasonable, do:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">bootstrap_q_ast</span>
</pre></div>
</div>
<p>This changes the source file meta/q_ast.ml. After this command, a new
‘make compare_q_ast’ indicates no differences.</p>
<p>After that, a new ‘make bootstrap’ in the top directory ensures that
everythings works.</p>
<p class="rubric" id="lisp-and-scheme-syntax-bootstrapping">Lisp and Scheme syntax bootstrapping</p>
<p>The Lisp syntax is written in Lisp syntax in the directory etc. It is
the file ‘etc/pa_lisp.ml’. To compile this file, there is another
file, named ‘etc/pa_lispr.ml’ written in revised syntax.</p>
<p>When changes are done in etc/pa_lisp.ml, the file etc/pa_lispr.ml
must be rebuilt. First, go to the directory ‘etc’ and type:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">compare_lisp</span>
</pre></div>
</div>
<p>If changes seem to be reasonable, do:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">boostrap_lisp</span>
</pre></div>
</div>
<p>This rebuilds ‘etc/pa_lispr.ml’. A new ‘make’ in the directory ‘etc’
will recompile it and recompile the Lisp version ‘etc/pa_lisp.ml’.</p>
<p>Bootstrap: etc/pa_lispr.ml allows to compile etc/pa_lisp.ml, and
changes is etc/pa_lisp.ml are reported in the source file
etc/pa_lispr.ml through ‘make bootstrap_lisp’.</p>
<p>Same for the Scheme syntax: the files are etc/pa_scheme.ml and
‘etc/pa_scheme.ml’.</p>
<p class="rubric" id="extend-statement-bootstrapping">EXTEND statement bootstrapping</p>
<p>The EXTEND statement of Camlp5 is a syntax extension. The file
‘meta/pa_extend.ml’ contains the statement for the adding of this
syntax extension, therefore something like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">EXTEND</span>
  <span class="n">expr</span><span class="p">:</span>
    <span class="p">[</span> <span class="p">[</span> <span class="s2">&quot;EXTEND&quot;</span> <span class="o">.....</span>
</pre></div>
</div>
<p>To be compiled, the file ‘meta/pa_extend.ml’ needs ‘pa_extend.cmo’.
This is actually its previous version in the directory ‘boot’. When
checking for a correct bootstrapping of Camlp5 (with the command
‘make compare’, for example), a test is done to verify that the
binary files ‘meta/pa_extend.cmo’ and ‘boot/pa_extend.cmo’ are the
same.</p>
<p>Notice that there is also a file ‘ocaml_src/meta/pa_extend.ml’ in
pure OCaml syntax, but, although this file is pretty printed, is is
hardly editable, because the expansion of the ‘EXTEND’ statement is a
very long expression rather difficult to understand. But this file
need not to be changes, since the command ‘make bootstrap_sources’
(see above) rebuilts it.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="about.html" class="btn btn-neutral float-right" title="About" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="library.html" class="btn btn-neutral float-left" title="Library" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2007-2017, INRIA (Institut National de Recherches en Informatique et Automatique). All rights reserved.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>